<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Interactive Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css" />
    <style>
      body {
        display: flex;
        margin: 0;
        height: 100vh;
        overflow: hidden;
        font-family: Arial, sans-serif; /* Custom font */
      }

      .w3-hide-large {
        z-index: 1000; /* Ensure sidebar is on top */
      }

      /* Sidebar */
      .w3-sidebar {
        z-index: 1000; /* Ensure sidebar is on top */
        height: 100vh; /* Full height */
      }

      /* Sidebar items */
      .sidebar-item {
        margin: 10px;
      }

      .sidebar-item label {
        display: flex;
        align-items: center;
        font-weight: bold;
      }

      .sidebar-item input[type="checkbox"] {
        margin-right: 10px;
      }

      /* Map container */
      #map {
        flex-grow: 1; /* Allow map to take remaining space */
        height: 100vh; /* Full height */
        width: calc(100% - 200px); /* Adjust width to account for the sidebar */
      }

      /* Adjust position for different screen sizes */
      .leaflet-control-zoom {
        position: relative; /* or 'fixed' if needed */
        top: 5px; /* Adjust for desired position */
        left: 205px; /* Adjust for desired position */
      }

      /* Media Query for Small Screens */
      @media (max-width: 768px) {
        .leaflet-control-zoom {
          top: 55px; /* Adjust top position on smaller devices */
          left: 0px; /* Adjust left position on smaller devices */
        }
      }

      .leaflet-control-zoom-in,
      .leaflet-control-zoom-out {
        background: rgba(255, 255, 255, 0.7); /* Slightly transparent background */
      }

      .top-left-container {
        width: 55px; /* Set the desired width */
        height: 55px; /* Set the desired height */
        position: absolute; /* Position it absolutely */
        top: 0; /* Align to top */
        left: 0; /* Align to left */
        background-color: #f0f0f0; /* Background color for visibility */
        border: 1px solid #ccc; /* Optional border for clarity */
        z-index: 900; /* Ensure it's on top */
      }
    </style>
  </head>
  <body>
    <div class="w3-sidebar w3-bar-block w3-collapse w3-card" style="width: 200px" id="mySidebar">
      <button class="w3-bar-item w3-button w3-hide-large" onclick="w3_close()">Close &times;</button>
      <div class="sidebar-item">
        <label for="seasonSelect">Select Season:</label>
        <select id="seasonSelect" class="w3-select">
          <option value="s1" selected>Season 1</option>
          <option value="s2">Season 2</option>
        </select>
      </div>
      <div class="sidebar-item">
        <label><input type="checkbox" id="toggleMarkers" checked /> Show Town Markers</label>
      </div>
      <div class="sidebar-item">
        <label><input type="checkbox" id="toggleRange1" /> Show Town Range</label>
      </div>
      <div class="sidebar-item">
        <label><input type="checkbox" id="toggleRange2" /> Show 1st Outpost Range</label>
      </div>
      <div class="sidebar-item">
        <label><input type="checkbox" id="toggleRange3" /> Show 2nd Outpost Range</label>
      </div>
    </div>

    <div class="top-left-container w3-main">
      <button class="w3-button w3-xlarge" onclick="w3_open()">&#9776;</button>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
      // Initialize map variables
      let currentSeason = "s1";
      let map;
      let towns = [];
      let plots = [];

      // Map dimensions
      const mapWidth = 256 * 4; // Adjust this based on your map size
      const mapHeight = 256 * 4;

      // Define bounds with a slight padding
      const padding = 256; // Adjust padding to allow near-edge panning
      const elasticBounds = [
        [-padding, -padding],
        [mapHeight + padding, mapWidth + padding],
      ];
      const hardBounds = [
        [0, 0],
        [mapHeight, mapWidth],
      ];

      // Resource enum
      const res_enum = {
        1: "fish",
        2: "stone",
        3: "salt",
        4: "copper",
        5: "iron",
        6: "gold",
        7: "lead",
        8: "whales",
      };

      // Function to initialize the map
      function initializeMap(season) {
        // Remove existing map if it exists
        if (map) {
          map.remove();
        }

        // Determine zoom level based on the season
        const zoomLevels = {
          s1: 5,
          s2: 6,
        };
        const maxZoom = zoomLevels[season];

        // Initialize the map
        map = L.map("map", {
          crs: L.CRS.Simple, // Use Simple CRS for pixel-based maps
          minZoom: 0,
          maxZoom: maxZoom, // Adjust this to your max zoom level based on the season
          zoom: 0, // Start zoom level
          center: [mapHeight / 2, mapWidth / 2], // Center map
          maxBoundsViscosity: 1.0, // Static bounds
        }).fitBounds(hardBounds);

        // Set elastic bounds to restrict panning
        map.setMaxBounds(elasticBounds);

        // Add tile layer with correct path
        L.tileLayer(`https://username.github.io/Mercatorio-Interactive-Map/assets/${season}/tiles/{z}/{x}/{y}.png`, {
          tileSize: 256, // Tile size in pixels
          noWrap: true, // Prevent wrapping
          continuousWorld: false, // No horizontal wrapping
          errorTileUrl: "error.png", // Error image for missing tiles
          bounds: hardBounds, // Define bounds to restrict tile loading
        }).addTo(map);

        // Fetch towns and plots data
        fetch(`https://username.github.io/Mercatorio-Interactive-Map/assets/${season}/towns.json`)
          .then(response => response.json())
          .then(data => {
            towns = data;
            loadTowns();
          });

        fetch(`https://username.github.io/Mercatorio-Interactive-Map/assets/${season}/plots.json`)
          .then(response => response.json())
          .then(data => {
            plots = data;
            updateResourceOverlays();
          });
      }

      // Function to load towns data and add markers
      function loadTowns() {
        // Clear existing markers and circles
        map.eachLayer((layer) => {
          if (layer instanceof L.Marker || layer instanceof L.Circle) {
            map.removeLayer(layer);
          }
        });

        // Add towns from the selected season
        towns.forEach((town) => {
          const iconUrl = town.capital
            ? "capital_marker.png"
            : "town_marker.png";
          const marker = L.icon({
            iconUrl: iconUrl,
            iconSize: [25, 25],
            iconAnchor: [12.5, 25],
            tooltipAnchor: [12.5, -12.5],
          });

          // Invert Y coordinate for correct placement
          const markerY = mapHeight - town.location.y / 4; // Invert Y to fit map convention
          const markerX = town.location.x / 4;

          // Add the marker
          L.marker([markerY, markerX], { icon: marker })
            .addTo(map)
            .bindTooltip(town.name);

          // Add range circles based on checkbox states
          if (document.getElementById("toggleRange1").checked) {
            L.circle([markerY, markerX], {
              radius: 50 / 4, // Divide radius by 4 for correct scaling
              fill: false,
              color: "#00DDFFFF", // light blue
              weight: 1,
              opacity: 0.5,
            }).addTo(map);
          }
          if (document.getElementById("toggleRange2").checked) {
            L.circle([markerY, markerX], {
              radius: 80 / 4, // Divide radius by 4 for correct scaling
              fill: false,
              color: "#FFF200FF", // yellow
              weight: 1,
              opacity: 0.5,
            }).addTo(map);
          }
          if (document.getElementById("toggleRange3").checked) {
            L.circle([markerY, markerX], {
              radius: 110 / 4, // Divide radius by 4 for correct scaling
              fill: false,
              color: "#FF0000", // red
              weight: 1,
              opacity: 0.5,
            }).addTo(map);
          }
        });
      }

      // Function to update resource overlays based on resource data
      function updateResourceOverlays() {
        // Clear existing overlays
        map.eachLayer((layer) => {
          if (layer instanceof L.LayerGroup) {
            map.removeLayer(layer);
          }
        });

        // Create overlays for each resource type
        Object.keys(res_enum).forEach((resId) => {
          if (document.getElementById(`toggle${res_enum[resId].charAt(0).toUpperCase() + res_enum[resId].slice(1)}`).checked) {
            const resourceGroup = L.layerGroup().addTo(map);

            plots.forEach((plot) => {
              if (plot.data.res === parseInt(resId)) {
                L.circle([mapHeight - plot.realY / 4, plot.realX / 4], {
                  radius: 20,
                  color: "#FF0000",
                  fillColor: "#FF0000",
                  fillOpacity: 0.5,
                }).addTo(resourceGroup);
              }
            });
          }
        });
      }

      // Event listener for season change
      document.getElementById("seasonSelect").addEventListener("change", (e) => {
        currentSeason = e.target.value;
        initializeMap(currentSeason);
      });

      // Event listeners for checkbox changes
      document.querySelectorAll(".sidebar-item input[type='checkbox']").forEach((checkbox) => {
        checkbox.addEventListener("change", updateResourceOverlays);
      });

      // Open sidebar function
      function w3_open() {
        document.getElementById("mySidebar").style.display = "block";
      }

      // Close sidebar function
      function w3_close() {
        document.getElementById("mySidebar").style.display = "none";
      }

      // Initialize map with default season
      initializeMap(currentSeason);
    </script>
  </body>
</html>
